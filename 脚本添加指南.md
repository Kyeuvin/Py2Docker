# 任务添加指南

本文档详细说明如何在 Docker 定时任务容器中添加新的任务，支持两种类型：定时执行任务和后台持续运行任务。

## 目录结构

```
cron_test/
├── task1/          # 定时任务示例
├── task2/          # 定时任务示例  
├── task3/          # 定时任务示例
├── task4/          # 后台任务示例（如果存在）
├── scripts/        # 管理脚本
├── logs/           # 日志目录
├── Dockerfile
├── docker-compose.yml
└── entrypoint.sh
```

## 一、添加定时执行任务

### 1.1 创建任务目录和脚本

```bash
# 创建新任务目录（例如 task5）
mkdir task5

# 创建 Python 脚本
cat > task5/main.py << 'EOF'
import time
import datetime

def main():
    print(f"Task5 开始执行 - {datetime.datetime.now()}")
    
    # 在这里添加你的业务逻辑
    # 例如：数据处理、API调用、文件操作等
    
    print(f"Task5 执行完成 - {datetime.datetime.now()}")

if __name__ == "__main__":
    main()
EOF
```

### 1.2 修改 Docker 配置

**修改 Dockerfile**：
```dockerfile
# 在复制应用文件部分添加新任务
COPY task1/ ./task1/
COPY task2/ ./task2/
COPY task3/ ./task3/
COPY task5/ ./task5/  # 添加这行
COPY scripts/ ./scripts/
```

**修改 docker-compose.yml**：
```yaml
environment:
  - TASK1_SCHEDULE=${TASK1_SCHEDULE:-0 */2 * * *}
  - TASK2_SCHEDULE=${TASK2_SCHEDULE:-*/30 * * * *}
  - TASK3_SCHEDULE=${TASK3_SCHEDULE:-0 9 * * 1}
  - TASK5_SCHEDULE=${TASK5_SCHEDULE:-0 6 * * *}  # 添加这行，默认每天6点执行
  - TIMEZONE=${TIMEZONE:-Asia/Shanghai}
  - LOG_LEVEL=${LOG_LEVEL:-INFO}
  - PYTHONUNBUFFERED=1
```

### 1.3 修改 entrypoint.sh

在 entrypoint.sh 中添加新任务的配置：

```bash
# 设置默认环境变量部分
export TASK1_SCHEDULE=${TASK1_SCHEDULE:-"0 */2 * * *"}
export TASK2_SCHEDULE=${TASK2_SCHEDULE:-"*/30 * * * *"}
export TASK3_SCHEDULE=${TASK3_SCHEDULE:-"0 9 * * 1"}
export TASK5_SCHEDULE=${TASK5_SCHEDULE:-"0 6 * * *"}  # 添加这行

# 在 crontab 配置部分添加
cat > /tmp/crontab << EOF
# Docker容器定时任务配置
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin
HOME=/root
PYTHONUNBUFFERED=1

# 任务1: $TASK1_SCHEDULE
$TASK1_SCHEDULE cd /app/task1 && python3 main.py >> /app/logs/task1.log 2>&1

# 任务2: $TASK2_SCHEDULE
$TASK2_SCHEDULE cd /app/task2 && python3 main.py >> /app/logs/task2.log 2>&1

# 任务3: $TASK3_SCHEDULE
$TASK3_SCHEDULE cd /app/task3 && python3 main.py >> /app/logs/task3.log 2>&1

# 任务5: $TASK5_SCHEDULE
$TASK5_SCHEDULE cd /app/task5 && python3 main.py >> /app/logs/task5.log 2>&1

EOF
```

### 1.4 部署和测试

```bash
# 重新构建容器
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 查看任务配置
docker exec -it cron-tasks crontab -l

# 查看日志
docker exec -it cron-tasks tail -f /app/logs/task5.log

# 手动测试任务
docker exec -it cron-tasks bash -c "cd /app/task5 && python3 main.py"
```

## 二、添加后台持续运行任务

### 2.1 创建后台任务脚本

```bash
# 创建后台任务目录（例如 task_bg）
mkdir task_bg

# 创建持续运行的 Python 脚本
cat > task_bg/main.py << 'EOF'
import time
import datetime
import signal
import sys

class BackgroundTask:
    def __init__(self):
        self.running = True
        # 注册信号处理器，用于优雅关闭
        signal.signal(signal.SIGTERM, self.stop)
        signal.signal(signal.SIGINT, self.stop)
    
    def stop(self, signum, frame):
        print(f"收到停止信号 {signum}，正在关闭...")
        self.running = False
    
    def run(self):
        print(f"后台任务启动 - {datetime.datetime.now()}")
        
        while self.running:
            try:
                # 在这里添加你的业务逻辑
                current_time = datetime.datetime.now()
                print(f"[{current_time}] 后台任务正在运行...")
                
                # 模拟工作（替换为实际业务逻辑）
                # 例如：监控文件变化、处理队列消息、API轮询等
                time.sleep(30)  # 每30秒执行一次
                
            except Exception as e:
                print(f"后台任务发生错误: {e}")
                time.sleep(5)  # 错误后等待5秒再重试
        
        print("后台任务已停止")

def main():
    task = BackgroundTask()
    task.run()

if __name__ == "__main__":
    main()
EOF
```

### 2.2 修改 Docker 配置

**修改 Dockerfile**：
```dockerfile
# 添加后台任务目录
COPY task_bg/ ./task_bg/
```

**修改 docker-compose.yml**：
```yaml
environment:
  - TASK_BG_ENABLED=${TASK_BG_ENABLED:-true}  # 后台任务开关
  # ... 其他环境变量
```

### 2.3 修改 entrypoint.sh

在 entrypoint.sh 中添加后台任务管理：

```bash
# 在健康检查启动后添加
# 启动后台任务
if [ "${TASK_BG_ENABLED:-true}" = "true" ] && [ -f "/app/task_bg/main.py" ]; then
    log_info "启动后台任务 task_bg..."
    nohup python3 /app/task_bg/main.py >> /app/logs/task_bg.log 2>&1 &
    TASK_BG_PID=$!
    log_info "后台任务已启动，PID: $TASK_BG_PID"
    echo $TASK_BG_PID > /app/logs/task_bg.pid
fi

# 在监控循环中添加进程检查
while true; do
    # ... 现有的 cron 服务检查代码 ...
    
    # 检查后台任务是否还在运行
    if [ -f "/app/logs/task_bg.pid" ]; then
        TASK_BG_PID=$(cat /app/logs/task_bg.pid)
        if ! kill -0 $TASK_BG_PID 2>/dev/null; then
            log_warn "后台任务已停止，尝试重启..."
            nohup python3 /app/task_bg/main.py >> /app/logs/task_bg.log 2>&1 &
            NEW_PID=$!
            echo $NEW_PID > /app/logs/task_bg.pid
            log_info "后台任务已重启，新PID: $NEW_PID"
        fi
    fi
    
    sleep 30
done
```

### 2.4 部署和测试

```bash
# 重新构建容器
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 查看后台任务进程
docker exec -it cron-tasks ps aux | grep task_bg

# 查看后台任务日志
docker exec -it cron-tasks tail -f /app/logs/task_bg.log

# 查看 PID 文件
docker exec -it cron-tasks cat /app/logs/task_bg.pid
```

## 三、常用 Cron 时间表达式

| 表达式 | 说明 |
|--------|------|
| `* * * * *` | 每分钟执行 |
| `*/5 * * * *` | 每5分钟执行 |
| `0 * * * *` | 每小时执行 |
| `0 */2 * * *` | 每2小时执行 |
| `0 9 * * *` | 每天上午9点执行 |
| `0 9 * * 1` | 每周一上午9点执行 |
| `0 9 1 * *` | 每月1号上午9点执行 |
| `30 23 * * 0` | 每周日晚上11:30执行 |

## 四、环境变量配置

### 4.1 通过 .env 文件配置

创建 `.env` 文件：
```bash
# 定时任务配置
TASK1_SCHEDULE=0 */2 * * *
TASK2_SCHEDULE=*/30 * * * *
TASK3_SCHEDULE=0 9 * * 1
TASK5_SCHEDULE=0 6 * * *

# 后台任务配置
TASK_BG_ENABLED=true

# 系统配置
TIMEZONE=Asia/Shanghai
LOG_LEVEL=INFO
```

### 4.2 通过 docker-compose 命令行配置

```bash
# 启动时指定环境变量
TASK5_SCHEDULE="*/10 * * * *" docker-compose up -d

# 或者导出环境变量
export TASK5_SCHEDULE="*/10 * * * *"
docker-compose up -d
```

## 五、日志管理和监控

### 5.1 查看日志

```bash
# 查看特定任务日志
./logs.sh  # 使用交互式脚本

# 或直接查看
docker exec -it cron-tasks tail -f /app/logs/task5.log
docker exec -it cron-tasks tail -f /app/logs/task_bg.log
```

### 5.2 任务管理

```bash
# 查看任务状态
docker exec -it cron-tasks bash /app/scripts/setup_cron.sh status

# 查看定时任务列表
docker exec -it cron-tasks bash /app/scripts/setup_cron.sh list

# 手动执行任务测试
docker exec -it cron-tasks bash -c "cd /app/task5 && python3 main.py"
```

## 六、注意事项

1. **环境变量设置**：确保在 crontab 中设置了正确的 PATH 环境变量
2. **Python 路径**：始终使用 `python3` 命令，确保兼容性
3. **日志输出**：使用 `>>` 追加日志，避免覆盖历史记录
4. **错误处理**：在 Python 脚本中添加适当的异常处理
5. **资源管理**：避免多个任务同时执行造成资源争用
6. **时区设置**：确保容器时区设置为 `Asia/Shanghai`
7. **重启策略**：后台任务需要考虑优雅关闭和自动重启机制

## 七、故障排除

### 7.1 常见问题

- **python3: not found**：检查 crontab 中的 PATH 环境变量设置
- **任务不执行**：检查 cron 服务状态和时间表达式格式
- **后台任务退出**：查看日志文件，检查错误信息
- **时区问题**：确认容器时区设置和 cron 时间表达式

### 7.2 调试方法

```bash
# 检查 cron 服务
docker exec -it cron-tasks service cron status

# 手动测试任务
docker exec -it cron-tasks bash -c "cd /app/taskX && python3 main.py"

# 查看系统日志
docker exec -it cron-tasks tail -f /var/log/cron.log
```

按照以上步骤，你可以轻松添加新的定时任务或后台持续运行任务到容器中。