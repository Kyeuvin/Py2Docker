# 多任务定时配置说明

## 配置方式

### 1. 单个任务（原有方式，向后兼容）

在 `docker-compose.yml` 中：

```yaml
environment:
  - CRON_ENABLED=true
  - CRON_SCHEDULE="0 8 * * *"  # 每天8点执行
  - CRON_LOG_FILE=/app/data/cron.log
```

### 2. 多个任务（新功能）

在 `docker-compose.yml` 中添加 `CRON_JOBS` 环境变量：

```yaml
environment:
  - CRON_ENABLED=true
  - CRON_LOG_FILE=/app/data/cron.log
  - CRON_JOBS="0 8 * * *|cd /app/src && python ckmovedataeveryday.py;0 14 * * *|cd /app/src && python main.py;0 0 * * 0|cd /app/src && python weekly_task.py"
```

## 格式说明

### CRON_JOBS 格式
```
"任务1时间|任务1命令;任务2时间|任务2命令;任务3时间|任务3命令"
```

- 使用 `;` (分号) 分隔不同的任务
- 使用 `|` (管道符) 分隔时间和命令
- 时间格式使用标准 crontab 格式：`分钟 小时 日期 月份 星期`

### 时间格式示例

| 表达式 | 说明 |
|--------|------|
| `0 8 * * *` | 每天上午8点 |
| `0 14 * * *` | 每天下午2点 |
| `30 9 * * 1-5` | 工作日上午9:30 |
| `0 0 * * 0` | 每周日午夜 |
| `0 0 1 * *` | 每月1号午夜 |
| `*/15 * * * *` | 每15分钟 |

## 配置示例

### 示例1：每日多次执行
```yaml
environment:
  - CRON_ENABLED=true
  - CRON_LOG_FILE=/app/data/cron.log
  - CRON_JOBS="0 8 * * *|cd /app/src && python morning_task.py;0 12 * * *|cd /app/src && python noon_task.py;0 18 * * *|cd /app/src && python evening_task.py"
```

### 示例2：不同频率任务
```yaml
environment:
  - CRON_ENABLED=true
  - CRON_LOG_FILE=/app/data/cron.log
  - CRON_JOBS="0 8 * * *|cd /app/src && python daily_task.py;0 9 * * 1|cd /app/src && python weekly_task.py;0 10 1 * *|cd /app/src && python monthly_task.py"
```

### 示例3：高频任务
```yaml
environment:
  - CRON_ENABLED=true
  - CRON_LOG_FILE=/app/data/cron.log
  - CRON_JOBS="*/5 * * * *|cd /app/src && python check_status.py;*/30 * * * *|cd /app/src && python sync_data.py;0 2 * * *|cd /app/src && python backup.py"
```

## 使用步骤

1. **修改 docker-compose.yml**：添加或修改 `CRON_JOBS` 环境变量

2. **重新构建容器**：
   ```bash
   docker-compose down
   docker-compose build
   docker-compose up -d
   ```

3. **验证配置**：
   ```bash
   # 进入容器
   docker-compose exec invoice-bot bash
   
   # 检查定时任务
   crontab -l
   
   # 查看cron服务状态
   service cron status
   ```

4. **查看日志**：
   ```bash
   # 查看定时任务执行日志
   docker-compose exec invoice-bot tail -f /app/data/cron.log
   ```

## 注意事项

1. **路径问题**：确保命令中的路径是正确的
2. **权限问题**：确保Python文件有执行权限
3. **日志管理**：所有任务的输出都会写入同一个日志文件
4. **时区设置**：确保容器时区设置正确（TZ=Asia/Shanghai）
5. **引号转义**：在YAML中使用引号时要注意转义

## 测试方法

可以使用短时间间隔进行测试：

```yaml
environment:
  - CRON_ENABLED=true
  - CRON_JOBS="*/1 * * * *|echo 'Test task 1 executed at $(date)';*/2 * * * *|echo 'Test task 2 executed at $(date)'"
```

这样每分钟执行一次任务1，每2分钟执行一次任务2，便于测试。 